<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>D.T</title>
<style>
body {
    background: #333;
}
#playGround {
    position: absolute;
    width: 600px;
    height: 400px;
    /*border: 1px solid #ccc;*/
    background: lightblue;
    overflow: hidden;
    /*margin: auto;*/
    top: 50%;
    left: 50%;
    margin-top: -200px;
    margin-left: -300px;
}
</style>
</head>
<body onload="DT.init({render:'playGround'});">
<div id="playGround"></div>
<script>
/* DT 07/24/2015 90%
* Dangerous Tour Episode 1
* Just for morden browsers
        ___  __
 /_)     |    /
/_)/_/   | o /_
   _/
*/
var DT = (function() {
    'use strict';
    var playGround = {
            title: 'Dangerous Tour',
            landing: false,
            vendors: ['webkit', 'moz'],
            assetSrc: 'images/assets.png',
            status: 'stop',
            assetList: [],
            weightList: [],
            bgColor: {
                intro: 'lightgreen',
                normal: 'lightblue',
                boss: 'purple'
            },
            version: '0.3 beta',
            gap: 45, // gap of each road
            amount: 4,
            deadline: false,
            process: {},
            bossLife: 3,
            bossGreenbelt: -120,
            fireScore: 20,
            oriBossLife: 3,
            grid: [],
            nodes: {},
            score: 0,
            vanish: 150,
            assetInfo: {
                car125cc: {
                    score: 30,
                    weight: 0.10,
                    width: 100,
                    height: 50,
                    position: '0 0'
                },
                van: {
                    score: 50,
                    weight: 0.10,
                    width: 100,
                    height: 60,
                    position: '0 -74px'
                },
                car300cc: {
                    score: 80,
                    weight: 0.10,
                    width: 100,
                    height: 50,
                    position: '0 -158px'
                },
                trunk: {
                    score: 70,
                    weight: 0.10,
                    width: 110,
                    height: 75,
                    position: '0 -225px'
                },
                car99cc: {
                    score: 20,
                    weight: 0.10,
                    width: 100,
                    height: 50,
                    position: '0 -315px'
                },
                pickup: {
                    score: 40,
                    weight: 0.10,
                    width: 100,
                    height: 50,
                    position: '0 -395px'
                },
                cop: {
                    score: 85,
                    weight: 0.15,
                    width: 100,
                    height: 55,
                    position: '0 -551px'
                },
                heavy: {
                    score: 90,
                    weight: 0.05,
                    width: 170,
                    height: 60,
                    position: '0 -627px'
                },
                taxi: {
                    score: 60,
                    weight: 0.10,
                    width: 100,
                    height: 55,
                    position: '0 -709px'
                },
                limousine: {
                    score: 100,
                    weight: 0.05,
                    width: 165,
                    height: 50,
                    position: '0 -790px'
                },
                mpv: {
                    score: 95,
                    weight: 0.05,
                    width: 190,
                    height: 60,
                    position: '0 -864px'
                }
            },
            hero: {
                width: 110,
                height: 40,
                position: '0 -479px'
            },
            cloud: {
                width: 125,
                height: 75,
                position: '-115px 0'
            },
            lawn: {
                height: 40,
                position: '0 -1361px'
            },
            greenbelt: [{
                width: 60,
                height: 55,
                position: '-180px -119px'
            }, {
                width: 40,
                height: 55,
                position: '-180px -195px'
            }, {
                width: 25,
                height: 55,
                position: '-180px -260px'
            }, {
                width: 35,
                height: 55,
                position: '-180px -331px'
            }, {
                width: 25,
                height: 25,
                position: '-180px -407px'
            }, {
                width: 25,
                height: 90,
                position: '-180px -456px'
            }],
            road: {
                height: 190,
                position: '0 -1401px'
            },
            flame: {
                width: 125,
                height: 125,
                position: '0 -950px'
            },
            fire: {
                width: 60,
                height: 35,
                position: '-180px -565px'
            },
            boss: {
                width: 180,
                height: 130,
                position: '0 -1102px'
            },
            board: {
                width: 75,
                height: 75
            },
            countdown: {
                gameover: {
                    width: 165,
                    height: 97,
                    position: '0 -1246px'
                },
                stageClear: {
                    width: 205,
                    height: 95,
                    position: '0 -1901px'
                },
                count1: {
                    width: 75,
                    height: 75,
                    position: '0 -1619px'
                },
                count2: {
                    width: 75,
                    height: 75,
                    position: '-75px -1619px'
                },
                count3: {
                    width: 75,
                    height: 75,
                    position: '-150px -1619px'
                }
            },
            weapon: {
                width: 88, //95
                height: 15, //25
                // position: '-145px -1864px'
                position: '0 -1869px'
            },
            life: {
                width: 60,
                height: 50,
                position: '0 -1807px'
            },
            btn: {
                width: 210,
                height: 65,
                position: '0 -2113px'
            },
            prop: {
                width: 52,
                height: 55,
                item: [{
                    name: 'shield',
                    className: 'blink',
                    position: '-188px -1082px'
                }, {
                    name: 'weapen',
                    className: 'super',
                    position: '-188px -1138px'
                }, {
                    name: 'misfortune',
                    className: 'inverse',
                    position: '-188px -1192px'
                }]
            },
            note: {
                width: 240,
                height: 75,
                position: '0 -2008px'
            },
            numbers: {
                width: 25,
                height: 40,
                position: '-215px -625px',
                gap: 45
            },
            words: {
                width: 25,
                height: 35,
                position: '-215px -2144px',
                gap: 40
            },
            author: {
                width: 240,
                height: 53,
                position: '0 -3347px'
            }
        },
        $ = function(id) { // sugar
            return document.getElementById(id);
        },
        rand = function(min, max, isInt) { // random, isInt: if true then return int
            if (isInt) {
                return Math.floor(Math.random() * (max - min + 1) + min);
            } else {
                return Math.random() * (max - min) + min;
            }
        },
        getRandomItemByWeight = function(list, weight) {
            var totalWeight = weight.reduce(function(prev, cur, i, arr) {
                    return prev + cur;
                }),
                index = rand(0, totalWeight),
                weightSum = 0;
            for (var i = 0, len = list.length; i < len; i++) {
                weightSum += weight[i];
                weightSum = +weightSum.toFixed(2);
                if (index <= weightSum) {
                    return list[i];
                }
            }
        },
        setNode = function(struct, parent) {
            var parent = parent || $(playGround.render),
                prmoteNode = function(struct) {
                    var node = document.createElement(struct.tagName);
                    node.id = struct.id;
                    node.style.cssText = struct.cssText;
                    if (struct.innerHTML) {
                        node.innerHTML = struct.innerHTML;
                    }
                    if (struct.className) {
                        node.className = struct.className;
                    }
                    if (node['id'].indexOf(playGround.render) > -1) {
                        playGround['nodes'][node['id'].replace(playGround.render, '').toLowerCase()] = node.id;
                    }
                    // parent.appendChild(node);
                    fragment.appendChild(node);
                },
                fragment = document.createDocumentFragment();
            if (Array.isArray(struct)) {
                var node = [];
                for (var i = 0, len = struct.length; i < len; i++) {
                    prmoteNode(struct[i]);
                }
            } else if (typeof struct === 'object') {
                prmoteNode(struct);
            }
            parent.appendChild(fragment);
        },
        onStageAnimationEnd = function(node, score) {
            addMultipleEvents(node, 'webkitAnimationEnd mozAnimationEnd animationend', function() {
                // if (document.contains(this)) {
                if (this) {
                    this.style.display = 'none';
                    $(playGround.render).removeChild(this);
                    if (score) {
                        playGround.score += score;
                        setScore(playGround.score);
                    }
                }
            });
        },
        setBoard = function() {
            var board = {
                    id: playGround.render + 'Board',
                    tagName: 'div',
                    cssText: 'position:absolute;top:' + (playGround.height - playGround.board.height) / 2 + 'px;left:' + (playGround.width - playGround.board.width) / 2 + 'px;width:' + playGround.board.width + 'px;height:' + playGround.board.height + 'px;z-index:2;'
                },
                score = {
                    id: playGround.render + 'Score',
                    tagName: 'span',
                    cssText: 'position:absolute;top:0;right:0;font-size:12px;z-index:9;display:none;'
                },
                note = {
                    id: playGround.render + 'Note',
                    tagName: 'div',
                    cssText: 'position:absolute;top:' + (playGround.leeway - playGround.note.height) / 2 + 'px;left:' + (playGround.width - playGround.note.width) / 2 + 'px;z-index:9;background:url(' + playGround.assetSrc + ') ' + playGround.note.position + ' no-repeat;width:' + playGround.note.width + 'px;height:' + playGround.note.height + 'px;padding:13px 33px;display:none;'
                },
                prop = {
                    id: playGround.render + 'Prop',
                    tagName: 'div',
                    cssText: 'position:absolute;left:' + (playGround.width - playGround.prop.width) / 2 + 'px;top:' + (playGround.leeway - playGround.prop.height) + 'px;background:url(' + playGround.assetSrc + ') ' + playGround['prop']['item'][0]['position'] + ' no-repeat;width:' + playGround.prop.width + 'px;height:' + playGround.prop.height + 'px;z-index:9;display:none;'
                },
                contents = '';
            for (var i = 0; i < 5; i++) {
                contents += '<div class="note" style="position:relative;float:left;width:' + playGround.numbers.width + 'px;height:' + playGround.numbers.height + 'px;margin:5px;background:url(' + playGround.assetSrc + ') ' + playGround.numbers.position + ' no-repeat;">&nbsp;</div>';
            }
            note.innerHTML = contents;
            setNode([board, score, note, prop]);
            setScore(0);
            setTrack();
        },
        getScore = function(score) {
            var score = score || playGround.score,
                flag = [],
                notes = $(playGround.nodes.note).querySelectorAll('.note'),
                index = notes.length - 1,
                pos = playGround['numbers']['position'].split(' ');
            for (var i = 0; i <= index; i++) {
                flag[i] = 0;
            }
            gameInterval('score', 1000, function(data) {
                var notes = $(playGround.nodes.note).querySelectorAll('.note'),
                    carry = function(index, flag) {
                        flag[index]++;
                        if (flag[index] >= 10) {
                            flag[index] = 0;
                            if (flag[(index - 1)] !== undefined) {
                                carry(index - 1, flag);
                            }
                        }
                        notes[index].style.backgroundPosition = pos[0] + ' ' + (-flag[index] * playGround.numbers.gap + parseInt(pos[1])) + 'px';
                        if (+flag.join('') >= score) {
                            abort('score');
                            $(playGround.nodes.btn).style.display = 'block';
                        }
                    };
                carry(index, flag);
            });
        },
        setStage = function() {
            var road = {
                    id: playGround.render + 'Stage',
                    tagName: 'div',
                    cssText: 'position:absolute;left:0;right:0;bottom:0;height:' + playGround.road.height + 'px;background:url(' + playGround.assetSrc + ') ' + playGround.road.position + ' repeat-x;',
                    className: 'road'
                },
                lawn = {
                    id: playGround.render + 'Lawn',
                    tagName: 'div',
                    cssText: 'position:absolute;left:0;right:0;bottom:' + playGround.road.height + 'px;height:' + playGround.lawn.height + 'px;background:url(' + playGround.assetSrc + ') ' + playGround.lawn.position + ' repeat-x;'
                },
                leeway = playGround.leeway - playGround.lawn.height,
                cloudLeeway = leeway - playGround.cloud.height,
                greenbeltLeeway = playGround.greenbelt.length - 1;
            setNode([road, lawn]);
            gameInterval('cloud', 0.5, function(data) {
                var seed = new Date().getTime(),
                    posY = rand(0, cloudLeeway, true),
                    display = playGround.deadline ? 'display:none;' : '',
                    cloud = {
                        id: 'cloud' + seed,
                        tagName: 'div',
                        cssText: 'position:absolute;top:' + posY + 'px;width:' + playGround.cloud.width + 'px;height:' + playGround.cloud.height + 'px;z-index:0;background:url(' + playGround.assetSrc + ') ' + playGround.cloud.position + ' no-repeat;' + display,
                        className: 'cloud whole'
                    };
                setNode(cloud);
                onStageAnimationEnd($(cloud.id));
            });
            gameInterval('tree', 2, function(data) {
                var seed = new Date().getTime(),
                    index = rand(0, greenbeltLeeway, true),
                    posX = playGround.deadline ? playGround.bossGreenbelt + 'px ' + playGround['greenbelt'][index]['position'].split(' ')[1] : playGround['greenbelt'][index]['position'],
                    greenbelt = {
                    id: 'greenbelt' + seed,
                    tagName: 'div',
                    cssText: 'position:absolute;top:' + (leeway - (playGround['greenbelt'][index]['height'] - playGround.lawn.height)) + 'px;width:' + playGround['greenbelt'][index]['width'] + 'px;height:' + playGround['greenbelt'][index]['height'] + 'px;z-index:0;background:url(' + playGround.assetSrc + ') ' + posX + ' no-repeat;',
                    className: 'greenbelt whole'
                };
                setNode(greenbelt);
                onStageAnimationEnd($(greenbelt.id));
            });
            setBoard();
        },
        setCommand = function(node, number, dir) {
            if (dir === 'up') {
                var prev = $(playGround.render).querySelector('.num' + (number - 1));
                node.style.top = prev.offsetTop + 'px';
                node.setAttribute('rel', prev.getAttribute('rel'));
            } else if (dir === 'down') {
                var next = $(playGround.render).querySelector('.num' + (number + 1))
                node.style.top = next.offsetTop + 'px';
                node.setAttribute('rel', next.getAttribute('rel'));
            } else {
                if ($(playGround.nodes.hero).className.indexOf('super') > -1) {
                    var seed = new Date().getTime(),
                        weapon = {
                            id: 'shoot' + seed,
                            tagName: 'div',
                            cssText: 'position:absolute;left:0;top:' + (playGround.grid[number] - playGround.gap / 4) + 'px;width:' + playGround.weapon.width + 'px;height:' + playGround.weapon.height + 'px;background:url(' + playGround.assetSrc + ') ' + playGround.weapon.position + ' no-repeat;z-index:8;',
                            className: 'weapon shoot'
                        };
                    setNode(weapon);
                    $(weapon.id).setAttribute('rel', number);
                    onStageAnimationEnd($(weapon.id));
                }
            }
        },
        setTrack = function() {
            var hero = {
                    id: playGround.render + 'Hero',
                    tagName: 'div',
                    cssText: 'position:absolute;left:' + playGround.gap + 'px;top:' + (playGround.grid[playGround.amount - 1] - playGround.gap / 4) + 'px;width:' + playGround.hero.width + 'px;height:' + playGround.hero.height + 'px;display:none;z-index:1;background:url(' + playGround.assetSrc + ') ' + playGround.hero.position + ' no-repeat;'
                },
                track,
                contents = '';
            for (var i = 0, len = playGround.amount; i < len; i++) {
                contents += '<div style="position:absolute;top:' + (playGround.grid[i] - playGround.gap / 4) + 'px;right:0;height:' + playGround.gap + 'px;left:0;z-index:3;" class="track num' + i + '" rel="' + i + '"></div>';
            }
            $(playGround.render).innerHTML += contents;
            setNode(hero);
            $(hero.id).setAttribute('rel', playGround.amount - 1);
            track = $(playGround.render).querySelectorAll('.track');
            eventPack(track, function(element) { // using mouse
                element.addEventListener('click', function(e) { // using mouse
                    if (playGround.status === 'play') {
                        var number = +$(hero.id).getAttribute('rel'),
                            curRel = +this.getAttribute('rel'),
                            dir;
                        if ($(hero.id).className.indexOf('inverse') < 0) {
                            if (number > curRel) { // up
                                setCommand($(hero.id), number, 'up');
                            } else if (number < curRel) { // down
                                setCommand($(hero.id), number, 'down');
                            } else {
                                setCommand($(hero.id), number, 'shoot');
                            }
                        }
                    }
                }, false);
            });
            window.addEventListener('keydown', function(e) { // using keyboard
                if (playGround.status === 'play') {
                    var e = e || window.event,
                        number = +$(hero.id).getAttribute('rel'),
                        dir;
                    if ((e.keyCode == 38 && number !== 0 && $(hero.id).className.indexOf('inverse') < 0) || (e.keyCode == 40 && number !== 0 && $(hero.id).className.indexOf('inverse') > -1)) { // up
                        setCommand($(hero.id), number, 'up');
                    } else if ((e.keyCode == 38 && number !== (playGround.amount - 1) && $(hero.id).className.indexOf('inverse') > -1) || (e.keyCode == 40 && number !== (playGround.amount - 1) && $(hero.id).className.indexOf('inverse') < 0)) {
                        setCommand($(hero.id), number, 'down');
                    } else if (e.keyCode == 32) { // space
                        setCommand($(hero.id), number, 'shoot');
                    }
                }
            }, true);
            addMultipleEvents($(playGround.nodes.hero), 'webkitAnimationEnd mozAnimationEnd animationend', function() {
                // if (document.contains(this)) {
                if (this && this.className.indexOf('shoot') > -1) {
                    this.style.display = 'none';
                }
            });
            setBoss();
        },
        setBoss = function() {
            var boss = {
                    id: playGround.render + 'Boss',
                    tagName: 'div',
                    cssText: 'position:absolute;left:' + (playGround.width - playGround.boss.width) + 'px;top:' + playGround.height / 2 + 'px;background:url(' + playGround.assetSrc + ') ' + playGround.boss.position + ' no-repeat;width:' + playGround.boss.width + 'px;height:' + playGround.boss.height + 'px;z-index:3;display:none;'
                },
                life = {
                    id: playGround.render + 'Life',
                    tagName: 'div',
                    cssText: 'position:absolute;left:' + (playGround.width - playGround.life.width * playGround.bossLife) / 2 + 'px;top:' + (playGround.leeway - playGround.life.height) / 2 + 'px;background:url(' + playGround.assetSrc + ') ' + playGround.life.position + ' repeat;width:' + playGround.life.width * playGround.bossLife + 'px;height:' + playGround.life.height + 'px;z-index:9;display:none;'
                }
            setNode([boss, life]);
            addMultipleEvents($(boss.id), 'webkitAnimationEnd mozAnimationEnd animationend', function() {
                if (this.className.indexOf('fear') > -1) {
                    setReactivity($(playGround.nodes.hero), $(playGround.nodes.boss));
                    this.className = 'boss'; // fire
                    this.setAttribute('rel', $(playGround.nodes.hero).getAttribute('rel'));
                }
            });
        },
        emptyNode = function(id) {
            var node = $(id);
            if (!node) {
                return;
            }
            while (node.firstChild) {
                node.removeChild(node.firstChild);
            }
        },
        setScore = function(score) {
            if (!score) {
                var notes = $(playGround.nodes.note).querySelectorAll('.note');
                for (var i = 0, len = notes.length; i < len; i++) {
                    notes[i].style.backgroundPosition = playGround.numbers.position;
                }
            }
            return $(playGround.nodes.score).innerHTML = 'SCORE: ' + score;
        },
        getEnding = function () {
            setWords(playGround.title);
            $(playGround.nodes.board).style.display = 'none';
            $(playGround.nodes.note).style.display = 'block';
            $(playGround.nodes.hint).style.display = 'block';
            getScore();
        },
        getStatus = function(node, type, className) {
            if (!node) {
                return;
            }
            var receiver = (type === 'hero') ? $(playGround.nodes.hero) : $(playGround.nodes.boss),
                receiverOffset = receiver.getBoundingClientRect(),
                nodeOffset = node.getBoundingClientRect(),
                board = $(playGround.nodes.board),
                nodeClass = className || '.' + node.className.split(' ')[0],
                showResult = function(board, result) {
                    board.style.marginTop = (playGround.board.height - playGround['countdown'][result]['height']) / 2 + 'px';
                    board.style.marginLeft = (playGround.board.width - playGround['countdown'][result]['width']) / 2 + 'px';
                    board.style.width = playGround['countdown'][result]['width'] + 'px';
                    board.style.height = playGround['countdown'][result]['height'] + 'px';
                    board.style.backgroundImage = 'url(' + playGround.assetSrc + ')';
                    board.style.backgroundPosition = playGround['countdown'][result]['position'];
                    board.style.backgroundRepeat = 'no-repeat';
                    board.style.display = 'block';
                    board.className = 'zoomIn';
                };
            if (nodeOffset.left && nodeOffset.left + nodeOffset.width >= receiverOffset.left && nodeOffset.left <= receiverOffset.left + receiverOffset.width && node.getAttribute('rel') === receiver.getAttribute('rel') && receiver.className.indexOf('blink') < 0) {
                abort(); ////////////
                receiver.className = 'accident';
                eventPack($(playGround.render).querySelectorAll(nodeClass), function(element) {
                    // if (document.contains(element)) {
                    if (element) {
                        $(playGround.render).removeChild(element);
                    }
                });
                if (type === 'hero') {
                    playGround.status = 'stop';
                    abort('boss');
                    $(playGround.nodes.boss).style.display = 'none';
                    $(playGround.nodes.life).style.display = 'none';
                    $(playGround.nodes.prop).style.display = 'none';
                    gameInterval('gameover', 1, function() {
                        receiver.style.display = 'none';
                        getEnding();
                    }, 1);
                    showResult(board, 'gameover');
                } else {
                    if (playGround.bossLife === 1) {
                        playGround.status = 'stop';
                        abort('boss');
                        $(playGround.nodes.life).style.display = 'none';
                        $(playGround.nodes.prop).style.display = 'none';
                        $(playGround.nodes.life).style.width = playGround.life.width * playGround.oriBossLife + 'px';
                        // playGround.bossLife = playGround.oriBossLife;
                        eventPack($(playGround.render).querySelectorAll('.fireball'), function(element) {
                            // if (document.contains(element)) {
                            if (element) {
                                $(playGround.render).removeChild(element);
                            }
                        });
                        gameInterval('beforeStageClear', 1, function() {
                            receiver.style.display = 'none';
                        }, 1, function() {
                            $(playGround.nodes.hero).className = 'shoot';
                            showResult(board, 'stageClear');
                            gameInterval('afterStageClear', 1, getEnding, 1);
                        });
                        return;
                    }
                    playGround.bossLife--;
                    $(playGround.nodes.life).style.width = playGround.life.width * playGround.bossLife + 'px';
                    receiver.className = 'blink';
                    gameInterval('beat', 1, function() {
                        receiver.className = 'boss fire';
                    }, 1);
                }
            }
        },
        getSence = function() {
            var index = rand(0, playGround.grid.length - 1, true),
                seed = new Date().getTime(),
                info = getRandomItemByWeight(playGround.assetList, playGround.weightList),
                item = {
                    id: 'item' + seed,
                    tagName: 'div',
                    cssText: 'position:absolute;top:' + (playGround.grid[index] - playGround.gap / 4 - (playGround['assetInfo'][info].height - playGround.hero.height)) + 'px;width:' + playGround['assetInfo'][info].width + 'px;height:' + playGround['assetInfo'][info].height + 'px;z-index:2;background:url(' + playGround.assetSrc + ') ' + playGround['assetInfo'][info].position + ' no-repeat;',
                    className: 'item coming'
                };
            setNode(item);
            $(item.id).setAttribute('rel', index);
            addMultipleEvents($(item.id), 'webkitAnimationEnd mozAnimationEnd animationend', function() {
                if (this.className.indexOf('over') > -1) {
                    // if (document.contains(this)) {
                    if (this) {
                        this.style.display = 'none';
                        $(playGround.render).removeChild(this);
                    }
                    playGround.score += playGround['assetInfo'][info]['score'];
                    setScore(playGround.score);
                } else {
                    this.className = 'item over';
                }
            });
        },
        eventPack = function(nodes, fn) {
            for (var i = 0, len = nodes.length; i < len; i++) {
                fn(nodes[i]);
            }
        },
        abort = function(name) {
            if (name) {
                cancelAnimationFrame(playGround['process'][name]);
                playGround['process'][name] = 0;
            } else {
                var except = [playGround.process.cloud, playGround.process.tree, playGround.process.boss];
                for (var key in playGround.process) {
                    if (playGround['process'][key] && except.indexOf(playGround['process'][key]) < 0) {
                        cancelAnimationFrame(playGround['process'][key]);
                        playGround['process'][key] = 0;
                    }
                }
            }
        },
        setReactivity = function(hero, boss) {
            var propSwitcher = true,
                propLeeway = playGround.prop.item.length - 1,
                propBase = rand(0, propLeeway, true),
                propRadix = playGround.score,
                propTimes = 0,
                propStep = 200,
                propIndex = 0;
            gameInterval('boss', 2, function() {
                var seed = new Date().getTime(),
                    bet = rand(0, 1, true),
                    index = rand(0, playGround.amount - 1, true),
                    // index = step,
                    posY = (playGround.grid[index] - playGround.gap / 4 - (playGround.fire.height - playGround.hero.height)),
                    fireball = {
                        id: 'fire' + seed,
                        tagName: 'div',
                        cssText: 'position:absolute;top:' + posY + 'px;width:' + (playGround.fire.width - 4) + 'px;height:' + playGround.fire.height + 'px;z-index:2;background:url(' + playGround.assetSrc + ') ' + playGround.fire.position + ' no-repeat;',
                        className: 'fireball burst'
                    };
                if (playGround.score >= (propRadix + propTimes) && propSwitcher) {
                    propSwitcher = false;
                    $(playGround.nodes.prop).style.display = 'block';
                    gameInterval('prop', 10, function() {
                        if (propBase > propLeeway) {
                            propBase = 0;
                        }
                        $(playGround.nodes.prop).style.backgroundPosition = playGround['prop']['item'][propBase]['position'];
                        propIndex = propBase;
                        propBase++;
                    }, 10, function() {
                        gameInterval('gain', 1, function() {
                            $(playGround.nodes.prop).style.display = 'none';
                        }, 1);
                        $(playGround.nodes.hero).className = playGround['prop']['item'][propIndex]['className'];
                        propTimes += propStep;
                        propSwitcher = true;
                    });
                }
                if (bet) {
                    setNode(fireball);
                    $(fireball.id).setAttribute('rel', index);
                    boss.style.top = (posY - 40) + 'px';
                    boss.setAttribute('rel', index);
                    boss.className = 'boss fire';
                    onStageAnimationEnd($(fireball.id), playGround.fireScore);
                }
                for (var i = 0, len = $(playGround.render).querySelectorAll('.fireball').length; i < len; i++) {
                    getStatus($(playGround.render).querySelectorAll('.fireball')[i], 'hero', '.fireball');
                }
                for (var i = 0, len = $(playGround.render).querySelectorAll('.weapon').length; i < len; i++) {
                    getStatus($(playGround.render).querySelectorAll('.weapon')[i], 'boss', '.weapon');
                }
            });
        },
        getBoss = function() { // get boss info
            var items,
                len,
                boss = $(playGround.nodes.boss),
                hero = $(playGround.nodes.hero);
            abort();
            items = $(playGround.render).querySelectorAll('.item');
            len = items.length;
            for (var i = 0; i < len; i++) {
                var style = getComputedStyle(items[i]),
                    transform = style.transform || style.webkitTransform || style.mozTransform,
                    posX = transform.split(',')[4] ? ~~transform.split(',')[4] : 0;
                items[i].className = 'item accident';
                items[i].style.left = posX + 'px';
                (function(index) {
                    setTimeout(function() {
                        items[index].style.display = 'none';
                        if (items[index]) {
                            $(playGround.render).removeChild(items[index]);
                        }
                    }, i * 300);
                })(i);
            }
            playGround.deadline = true;
            $(playGround.render).style.backgroundColor = 'purple';
            setTimeout(function() {
                $(playGround.nodes.life).style.display = 'block';
                boss.style.display = 'block';
                boss.className = 'fear';
            }, len * 300);

        },
        getStarted = function() {
            var pedometer = 3,
                board = $(playGround.nodes.board),
                hero = $(playGround.nodes.hero),
                go = function() {
                    var step = 0,
                        bossTime = rand(66, 77, true); //////
                    playGround.score = 0;
                    setScore(0);
                    playGround.status = 'play';
                    hero.style.display = 'block';
                    hero.className = 'zen';
                    gameInterval('getStarted', 5, function() {
                        step += 0.5;
                        if (step >= 4) {
                            getSence();
                            step = 0;
                        }
                        for (var i = 0, len = $(playGround.render).querySelectorAll('.item').length; i < len; i++) {
                            getStatus($(playGround.render).querySelectorAll('.item')[i], 'hero', '.item');
                        }
                    }, bossTime, function() {
                        getBoss();
                    });
                };
            playGround.deadline = false;
            playGround.bossLife = playGround.oriBossLife;
            $(playGround.render).style.backgroundColor = playGround.bgColor.normal;
            $(playGround.nodes.life).style.width = playGround.life.width * playGround.oriBossLife + 'px';
            $(playGround.nodes.btn).style.display = 'none';
            $(playGround.nodes.note).style.display = 'none';
            $(playGround.nodes.hint).style.display = 'none';
            gameInterval('countdown', 1, function() {
                board.style.marginTop = 0;
                board.style.marginLeft = 0;
                board.style.width = playGround['countdown']['count' + pedometer]['width'] + 'px';
                board.style.height = playGround['countdown']['count' + pedometer]['height'] + 'px';
                board.style.backgroundImage = 'url(' + playGround.assetSrc + ')';
                board.style.backgroundPosition = playGround['countdown']['count' + pedometer]['position'];
                board.style.backgroundRepeat = 'no-repeat';
                board.style.display = 'block';
                board.className = 'zoomIn';
                if (pedometer > 1) {
                    pedometer--;
                }
            }, 3, function() {
                board.style.display = 'none';
                board.className = '';
                return go();
            });
        },
        addMultipleEvents = function(element, events, handle) {
            var tokens = events.split(' ');
            for (var i = 0, len = tokens.length; i < len; i++) {
                element.addEventListener(tokens[i], handle);
            }
        },
        areEqual = function() {
            for (var i = 1, len = arguments.length; i < len; i++) {
                if (arguments[i] == null || arguments[i] != arguments[i - 1]) {
                    return false;
                }
            }
            return true;
        },
        areArrays = function() {
            for (var i = 0, len = arguments.length; i < len; i++) {
                if (!Array.isArray(arguments[i])) { // Object.prototype.toString.call(arguments[i]) === '[object Array]'
                    return false;
                }
            }
            return true;
        },
        setStyles = function(name, styleString) {
            var cssStyle,
                contents = '',
                feasibility = false;
            if (typeof name === 'string') {
                contents = name + '{' + styleString + '}';
                feasibility = true;
            } else if (areArrays([name, styleString]) && areEqual(name.length, styleString)) {
                for (var i = 0, len = name.length; i < len; i++) {
                    contents += name[i] + '{' + styleString[i] + '}';
                }
                feasibility = true;
            }
            if (feasibility) {
                cssStyle = document.createElement('style');
                // cssStyle.type = 'text/css';
                cssStyle.appendChild(document.createTextNode(contents));
                document.getElementsByTagName('head')[0].appendChild(cssStyle);
            }
        },
        setKeyFrames = function(name, keyString, classString, styleString) { // just for transform
            var cssAnimation,
                prefix = ['-webkit-', '-moz-', ''],
                contents = '',
                feasibility = false,
                addPrefix = function(nameStr, keyStr, classStr, styleStr) {
                    var tmpStrOne = '',
                        tmpStrTwo = '.' + nameStr + '{';
                    for (var i = 0, len = prefix.length; i < len; i++) {
                        tmpStrOne += keyStr.replace('keyframes', '@' + prefix[i] + 'keyframes').replace(/transform/g, prefix[i] + 'transform').replace(/animation/g, prefix[i] + 'animation');
                        tmpStrTwo += classStr.replace(/animation/g, prefix[i] + 'animation');
                    }
                    return tmpStrOne + tmpStrTwo + styleStr + '}';
                };
            if (typeof name === 'string') {
                var curName = (name.indexOf(':') > -1) ? name.split(':')[0] : name;
                contents = addPrefix(name, 'keyframes ' + curName + '{' + keyString + '}', classString, styleString);
                feasibility = true;
            } else if (areArrays([name, keyString, classString, styleString]) && areEqual(name.length, keyString.length, classString.length, styleString.length)) {
                for (var i = 0, len = name.length; i < len; i++) {
                    var curName = (name[i].indexOf(':') > -1) ? name[i].split(':')[0] : name[i];
                    contents += addPrefix(name[i], 'keyframes ' + curName + '{' + keyString[i] + '}', classString[i], styleString[i]);
                }
                feasibility = true;
            }
            if (feasibility) {
                cssAnimation = document.createElement('style');
                // cssAnimation.type = 'text/css';
                cssAnimation.appendChild(document.createTextNode(contents));
                document.getElementsByTagName('head')[0].appendChild(cssAnimation);
            }
        },
        setClass = function() {
            var timer = 5,
                mid = playGround.gap + playGround.hero.width,
                action = ['animation:coming ' + timer + 's linear;',
                    'animation:over ' + ((mid * timer) / playGround.width).toFixed(2) + 's linear;',
                    'animation:road ' + timer + 's linear infinite;',
                    'animation:fire 1s infinite;',
                    'animation:boss 2s infinite ease-in-out;',
                    'animation:whole ' + timer + 's linear;',
                    'animation:zoomIn 1s infinite;',
                    'animation:zen 1s linear;',
                    'animation:fear 1s linear;',
                    'animation:shoot 1s linear;',
                    'animation:burst ' + timer + 's linear;',
                    'animation:blink 0.5s linear infinite;',
                    'animation:flipInX 3s;'
                ],
                stagePosY = playGround.road.position.split(' ')[1];
            setKeyFrames(['coming', 'over', 'road', 'fire:after', 'boss', 'whole', 'zoomIn', 'zen', 'fear', 'shoot', 'burst', 'blink', 'flipInX'], ['from{transform:translateX(' + playGround.width + 'px);}to{transform:translateX(' + mid + 'px);}', 'from{transform:translateX(' + mid + 'px);}to{transform:translateX(-' + playGround.hero.width + 'px);}', 'from {background-position:0 ' + stagePosY + ';}to{background-position:-100% ' + stagePosY + ';}', '0%{opacity:1;}100%{opacity:0;}', '0%{margin-top:0;margin-left:0;}25%{margin-top:-2px;margin-left:-2px;}70%{margin-top:2px;margin-left:-4px;}100%{margin-top:-1px;margin-left:0;}', 'from{transform:translateX(' + playGround.width + 'px);}to{transform:translateX(-' + playGround.vanish + 'px);}', '0%{opacity:0;transform:scale3d(0.3,0.3,0.3);}50%{opacity: 1;}', 'from{transform:translateX(-' + playGround.hero.width + 'px);}to{transform:translateX(0);}', 'from{transform:translateX(' + playGround.boss.width + 'px);}to{transform:translateX(0);}', 'from{transform:translateX(' + (playGround.hero.width + playGround.gap) + 'px);}to{transform:translateX(' + playGround.width + 'px);}', 'from{transform:translateX(' + (playGround.width - playGround.boss.width) + 'px);}to{transform:translateX(-' + playGround.fire.width + 'px);}', '0%{opacity:1;}50%{opacity:0;}100%{opacity:1;}', '0%{transform:perspective(400px) rotate3d(1,0,0,90deg);animation-timing-function:ease-in;opacity:0;}40%{transform:perspective(400px) rotate3d(1,0,0,-20deg);animation-timing-function:ease-in;}60%{transform:perspective(400px) rotate3d(1,0,0,10deg);opacity:1;}80%{transform: perspective(400px) rotate3d(1,0,0,-5deg);}100%{transform: perspective(400px);}'], action, ['', '', '', 'content:\'\';position:absolute;width:' + playGround.fire.width + 'px;height:' + playGround.fire.height + 'px;background:url(' + playGround.assetSrc + ') ' + playGround.fire.position + ' no-repeat;left:1px;top:' + playGround.boss.height * 0.3 + 'px;', '', '', '', '', '', '', '', '', '-webkit-backface-visibility:visible!important;backface-visibility:visible!important;']);
            setStyles('.accident:after', 'content:\'\';position:absolute;left:0;top:' + (playGround.hero.height - playGround.flame.height) / 2 + 'px;width:' + playGround.flame.width + 'px;height:' + playGround.flame.height + 'px;background:url(' + playGround.assetSrc + ') ' + playGround.flame.position + ' no-repeat;z-index:3;');
        },
        gameInterval = function(name, fps, fn, timeout, callback) {
            var fps = fps || 1,
                now,
                delta,
                interval = 1000 / fps,
                step = 0,
                then = Date.now();
            if (!name || playGround['process'][name]) {
                return;
            }
            // if (playGround['process'][name]) {
            //     cancelAnimationFrame(playGround['process'][name]);
            //     playGround['process'][name] = 0;
            // }
            // abort();/////////
            return (function loop() {
                playGround['process'][name] = requestAnimationFrame(loop);
                now = Date.now();
                delta = now - then;
                if (delta > interval) {
                    if (timeout && step >= timeout) {
                        callback && callback();
                        step = 0; //////
                        abort(name);
                        return;
                    }
                    then = now - (delta % interval);
                    fn && fn(step);
                    step++;
                }
            }());
        },
        setIntro = function() {
            if (!playGround['nodes'].hasOwnProperty('hint')) {
                var hint = {
                    id: playGround.render + 'Hint',
                    tagName: 'div',
                    cssText: 'position:absolute;top:0;right:0;bottom:0;left:0;background:' + playGround.bgColor.intro + ';padding:10px;'
                };
                setNode(hint);
            }
            var runtime = false,
                logo = {
                    id: playGround.render + 'Logo',
                    tagName: 'div',
                    cssText: 'position:relative;width:' + playGround.author.width + 'px;height:' + playGround.author.height + 'px;background:url(' + playGround.assetSrc + ') ' + playGround.author.position + ' no-repeat;'
                };
            setNode(logo, $(playGround.nodes.hint));
            gameInterval('present', 1, function() {
                getWords('present', $(playGround.nodes.hint));
            }, 1, function() {
                gameInterval('coder', 1, function() {
                    getWords('Code: Zen');
                }, 1, function() {
                    gameInterval('UI', 1, function() {
                        getWords('UI: Carol');
                    }, 1, function() {
                        gameInterval('landing', 1, function() {
                            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                                getWords('Err: your browser is not supported for this app');
                            } else {
                                getWords('Loading...');
                                runtime = true;
                            }
                        }, 1, function() {
                            if (runtime) {
                                var img = new Image();
                                img.src = playGround.assetSrc;
                                img.onload = function() {
                                    gameInterval('showtime', 1, function() {
                                        emptyNode(playGround.nodes.hint);
                                        setTimeout(function () {
                                            setWords(playGround.title);
                                        }, 0);
                                        setStage();
                                    }, 1, function() {
                                        $(playGround.nodes.btn).className = 'flipInX';
                                        $(playGround.nodes.btn).style.display = 'block';
                                    });
                                }
                            }
                        });
                    });
                });
            });
        },
        setWords = function(words, clear) {
            emptyNode(playGround.nodes.hint);
            $(playGround.nodes.hint).style.display = 'block';
            getWords(words, $(playGround.nodes.hint), clear);
        },
        getWords = function(words, node, clear) {
            if (!words) {
                return;
            }
            if (words === 'Zen' && playGround['nodes'].hasOwnProperty('hero')) {
                $(playGround.nodes.hero).className = 'blink';
            }
            var seed = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ_:. ',
                node = node || $(playGround.nodes.hint),
                wordsArray = (words + '_').toUpperCase().split(''),
                len = wordsArray.length,
                lastWordIndex = len - 1,
                pos = playGround['words']['position'].split(' '),
                leeway = parseInt(pos[1]);
            if (clear) {
                node.innerHTML = '';
            } else {
                if (node.querySelector('.blink')) {
                    node.removeChild(node.querySelector('.blink'));
                }
                node.innerHTML += '<div style="clear:both;"></div>';
            }
            for (var i = 0; i < len; i++) {
                (function(index) {
                    setTimeout(function() {
                        node.innerHTML += '<div class="word" style="position:relative;float:left;width:' + playGround.words.width + 'px;height:' + playGround.words.height + 'px;margin:5px;background:url(' + playGround.assetSrc + ') ' + pos[0] + ' ' + (leeway - playGround.words.gap * seed.indexOf(wordsArray[index])) + 'px no-repeat;" rel="' + wordsArray[index] + '">&nbsp;</div>';
                        if (index === lastWordIndex) {
                            node.querySelector('.word:last-child').className = 'word blink';
                        }
                    }, i * 100);
                })(i);
            }
        },
        init = function(opts) {
            var btn;
            if (playGround.process.getStarted || !opts || (opts && !opts.render)) {
                return;
            }
            if ($(opts.render)) {
                emptyNode(opts.render);
            } else {
                document.addEventListener('touchmove', function(e) {
                    e.preventDefault();
                }, false);
            }
            playGround.render = opts.render;
            playGround.amount = opts.amount || playGround.amount;
            playGround.width = $(opts.render).clientWidth;
            playGround.height = $(opts.render).clientHeight;
            playGround.grid.length = 0;
            playGround.leeway = playGround.height - playGround.road.height;
            for (var i = 0; i < playGround.vendors.length && !window.requestAnimationFrame; ++i) {
                window.requestAnimationFrame = window[playGround['vendors'][i] + 'RequestAnimationFrame'];
                window.cancelAnimationFrame = window[playGround['vendors'][i] + 'CancelAnimationFrame'] || window[playGround['vendors'][i] + 'CancelRequestAnimationFrame'];
            }
            for (var i = 0; i < playGround.amount; i++) {
                playGround.grid.push(playGround.leeway + playGround.gap * i);
            }
            playGround.assetList = Object.keys(playGround.assetInfo);
            playGround.weightList = playGround.assetList.map(function(key) {
                return playGround['assetInfo'][key]['weight'];
            });
            if (!playGround.landing) {
                playGround.landing = true;
                setClass();
            }
            setIntro();
            // setStage();//////
            playGround.status = 'ready';
            btn = {
                id: playGround.render + 'Btn',
                tagName: 'div',
                cssText: 'position:absolute;top:' + (playGround.height - playGround.btn.height) / 2 + 'px;left:' + (playGround.width - playGround.btn.width) / 2 + 'px;width:' + playGround.btn.width + 'px;height:' + playGround.btn.height + 'px;background:url(' + playGround.assetSrc + ') ' + playGround.btn.position + ' no-repeat;z-index:9;cursor:pointer;display:none;'
            };
            setNode(btn);
            // $(btn.id).addEventListener('click', getStarted, false);
            $(playGround.render).addEventListener('click', function(e) {
                if (e.target.id === btn.id) {
                    getStarted();
                }
            }, false);
        };
    return {
        init: init,
        getScore: function() {
            return playGround.score;
        },
        setWords: setWords
    };
}());
</script>
</body>
</html>
